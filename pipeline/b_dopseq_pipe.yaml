# Processing of sequencing data of DOP-PCR libraries from isolated chromosomes 
# Usage: dopseq_pipe.py [-d] dopseq_pipe.config
# Option: -d - dry run: print out commands and exit
# Output files are written to current folder. For details see comments below.
# Expects all executables in ../exec/ relative to b_dopseq_pipe.py

### Assignable parameters

# sample name - used as prefix for output files
sample: VVUB

# path to file with forward reads
fastq_F_file: test.F.fastq
# path to file with reverse reads, comment out in case of single-end reads
fastq_R_file: test.R.fastq 

# genomes
# path to fasta file of target genome
target_genome: /genome/canFam3/canFam3.masked.fa 
# path to fasta file of contamination genome (human in our case)
# commenting out contam_genome disables alignment to contamination genome and contam_filter (Step 3.)
contam_genome: /genome/hg19/hg19.fa 
# note that for bowtie2 and bwa index files are expected in the same folder with proper basenames: 
# e.g. canFam3 for canFam3.masked.fasta, hg19 for hg19.fa 

# read trimming
cutadapt_path: cutadapt # do not use '~' in path
# amplification protocol - used to remove specific primers. Possible values: dop, wga, none.
ampl: wga 
# additional parameters for cutadapt specified as quoted string
cutadapt_args: "--trim-n --minimum-length 20" 
# for WGA you may want to increase error toleance with -e 0.2-0.3

# read mapping
# Aligner to use. Possible values: bt2 (for bowtie2), bwa, bbm (for bbmap)
aln: bt2 
bowtie2_path: bowtie2 # do not use '~' in path
# Additional parameters for bowtie2 specified as quoted string
bowtie2_args: "-p 1 --very-sensitive-local" 
bwa_path: bwa # do not use '~' in path
# Additional parameters for bwa specified as quoted string
bwa_args: "mem -t 1" 
bbmap_path: bbmap.sh # do not use '~' in path
# Additional parameters for bbmap specified as quoted string.
# nodisc option can be used in order to prevent genome index writing to working directory
bbmap_args: "threads=1" 

# read filtering
# minimum mapping quality for mapped read retention. Works both with and without contamination filtering.
min_mapq: 20 

# region calling
# tab-separated file with chromosomes and their sizes.
# only chromosomes listed in this file are processed in region calling
sizes_file: ../examples/canFam3.sizes 

### Pipeline step-by-step

# Step 1. fastq_clean.py - removes residual Illumina adapters and primers from input fastq files
# Output files: sample.ca.R1.fastq(.gz), [sample.ca.R2.fastq(.gz),] sample.ca.log

# Step 2. fastq_aln.py - aligns trimmed reads to target and contamination genomes using bowtie2, bwa or bbmap.
# Output files: sample.target_genome.sam, sample.target_genome.bt2.log, [sample.contam_genome.sam, sample.contam_genome.bt2.log]

# Step 3. contam_filter.py - Removes contamination reads by comparing MAPQs to target and cotamination genomes. Outputs sorted and indexed bams.
# Requires pysam
# Output file: sample.target_genome.filter.bam

# Step 4. bam_to_bed.py - creates bed file with non-overlapping positions of reads in target genome
# Input files to start from this step: sample.target_genome.filter.bam
# Other parameters: --path_to_bedtools
# Output file: sample.target_genome.filter.pos.bed

# Step 5. regions_dnacopy.R - classifies chromosomes listed in .sizes file based on distances between consecutive read positions
# Requires R::DNAcopy (installation commands available in script)
# Output files: sample.target_genome.reg.tsv, sample.target_genome.reg.pdf

# Other scripts

# You also can run pipeline for variant calling with GATK HaplotypeCaller and annotation with snpEff for these regions
# vca_reg.py vca_reg.conf

# Input for RepeatExplorer (interleaved fasta with minimum read length 18 - word size) can be generated
# sample.[FR].ca.fastq files are used as input
# ../exec/fastq_repexpl.py [-r] sample
